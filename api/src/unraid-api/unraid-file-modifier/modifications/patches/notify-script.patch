Index: /usr/local/emhttp/plugins/dynamix/scripts/notify
===================================================================
--- /usr/local/emhttp/plugins/dynamix/scripts/notify	original
+++ /usr/local/emhttp/plugins/dynamix/scripts/notify	modified
@@ -29,10 +29,11 @@
   use -l to specify a link (clicking the notification will take you to that location)
   use -x to create a single notification ticket
   use -r to specify recipients and not use default
   use -t to force send email only (for testing)
   use -b to NOT send a browser notification
+  use -u to specify a custom filename (API use only)
   all options are optional
 
 notify init
   Initialize the notification subsystem.
 
@@ -85,16 +86,17 @@
   }
   $body[]    = "";
   return mail($to, $subj, implode("\n", $body), implode("\n", $headers));
 }
 
-function safe_filename($string) {
+function safe_filename($string, $maxLength=255) {
   $special_chars = ["?", "[", "]", "/", "\\", "=", "<", ">", ":", ";", ",", "'", "\"", "&", "$", "#", "*", "(", ")", "|", "~", "`", "!", "{", "}"];
   $string = trim(str_replace($special_chars, "", $string));
-  $string = preg_replace('~[^0-9a-z -_]~i', '', $string);
+  $string = preg_replace('~[^0-9a-z -_.]~i', '', $string);
   $string = preg_replace('~[- ]~i', '_', $string);
-  return trim($string);
+  // limit filename length to $maxLength characters
+  return substr(trim($string), 0, $maxLength);
 }
 
 /*
    Call this when using the subject field in email or agents. Do not use when showing the subject in a browser.
    Removes all HTML entities from subject line, is specifically targetting the my_temp() function, which adds '&#8201;&#176;'
@@ -102,10 +104,42 @@
 function clean_subject($subject) {
   $subject = preg_replace("/&#?[a-z0-9]{2,8};/i"," ",$subject);
   return $subject;
 }
 
+/**
+ * Wrap string values in double quotes for INI compatibility and escape quotes/backslashes.
+ * Numeric types remain unquoted so they can be parsed as-is.
+ */
+function ini_encode_value($value) {
+  if (is_int($value) || is_float($value)) return $value;
+  if (is_bool($value)) return $value ? 'true' : 'false';
+  $value = (string)$value;
+  return '"'.strtr($value, ["\\" => "\\\\", '"' => '\\"']).'"';
+}
+
+function build_ini_string(array $data) {
+  $lines = [];
+  foreach ($data as $key => $value) {
+    $lines[] = "{$key}=".ini_encode_value($value);
+  }
+  return implode("\n", $lines)."\n";
+}
+
+/**
+ * Trims and unescapes strings (eg quotes, backslashes) if necessary.
+ */
+function ini_decode_value($value) {
+  $value = trim($value);
+  $length = strlen($value);
+  if ($length >= 2 && $value[0] === '"' && $value[$length-1] === '"') {
+    return stripslashes(substr($value, 1, -1));
+  }
+  return $value;
+}
+
+
 // start
 if ($argc == 1) exit(usage());
 
 extract(parse_plugin_cfg("dynamix",true));
 
@@ -176,12 +210,13 @@
   $timestamp = time();
   $ticket = $timestamp;
   $mailtest = false;
   $overrule = false;
   $noBrowser = false;
+  $customFilename = false;
 
-  $options = getopt("l:e:s:d:i:m:r:xtb");
+  $options = getopt("l:e:s:d:i:m:r:u:xtb");
   foreach ($options as $option => $value) {
     switch ($option) {
      case 'e':
       $event = $value;
       break;
@@ -213,19 +248,54 @@
      case 'l':
       $nginx = (array)@parse_ini_file('/var/local/emhttp/nginx.ini');
       $link = $value;
       $fqdnlink = (strpos($link,"http") === 0) ? $link : ($nginx['NGINX_DEFAULTURL']??'').$link;
       break;
+     case 'u':
+      $customFilename = $value;
+      break;
     }
   }
 
-  $unread = "{$unread}/".safe_filename("{$event}-{$ticket}.notify");
-  $archive = "{$archive}/".safe_filename("{$event}-{$ticket}.notify");
+  if ($customFilename) {
+    $filename = safe_filename($customFilename);
+  } else {
+    // suffix length: _{timestamp}.notify = 1+10+7 = 18 chars.
+    $suffix = "_{$ticket}.notify";
+    $max_name_len = 255 - strlen($suffix);
+    // sanitize event, truncating it to leave room for suffix
+    $clean_name = safe_filename($event, $max_name_len);
+    // construct filename with suffix (underscore separator matches safe_filename behavior)
+    $filename = "{$clean_name}{$suffix}";
+  }
+
+  $unread = "{$unread}/{$filename}";
+  $archive = "{$archive}/{$filename}";
+
   if (file_exists($archive)) break;
   $entity = $overrule===false ? $notify[$importance] : $overrule;
-  if (!$mailtest) file_put_contents($archive,"timestamp=$timestamp\nevent=$event\nsubject=$subject\ndescription=$description\nimportance=$importance\n".($message ? "message=".str_replace('\n','<br>',$message)."\n" : ""));
-  if (($entity & 1)==1 && !$mailtest && !$noBrowser) file_put_contents($unread,"timestamp=$timestamp\nevent=$event\nsubject=$subject\ndescription=$description\nimportance=$importance\nlink=$link\n");
+  $cleanSubject = clean_subject($subject);
+  $archiveData = [
+    'timestamp' => $timestamp,
+    'event' => $event,
+    'subject' => $cleanSubject,
+    'description' => $description,
+    'importance' => $importance,
+  ];
+  if ($message) $archiveData['message'] = str_replace('\n','<br>',$message);
+  if (!$mailtest) file_put_contents($archive, build_ini_string($archiveData));
+  if (($entity & 1)==1 && !$mailtest && !$noBrowser) {
+    $unreadData = [
+      'timestamp' => $timestamp,
+      'event' => $event,
+      'subject' => $cleanSubject,
+      'description' => $description,
+      'importance' => $importance,
+      'link' => $link,
+    ];
+    file_put_contents($unread, build_ini_string($unreadData));
+  }
   if (($entity & 2)==2 || $mailtest) generate_email($event, clean_subject($subject), str_replace('<br>','. ',$description), $importance, $message, $recipients, $fqdnlink);
   if (($entity & 4)==4 && !$mailtest) { if (is_array($agents)) {foreach ($agents as $agent) {exec("TIMESTAMP='$timestamp' EVENT=".escapeshellarg($event)." SUBJECT=".escapeshellarg(clean_subject($subject))." DESCRIPTION=".escapeshellarg($description)." IMPORTANCE=".escapeshellarg($importance)." CONTENT=".escapeshellarg($message)." LINK=".escapeshellarg($fqdnlink)." bash ".$agent);};}};
   break;
 
 case 'get':
@@ -239,13 +309,16 @@
     $time = true;
     $output[$i]['file'] = basename($file);
     $output[$i]['show'] = (fileperms($file) & 0x0FFF)==0400 ? 0 : 1;
     foreach ($fields as $field) {
       if (!$field) continue;
-      [$key,$val] = array_pad(explode('=', $field),2,'');
+      # limit the explode('=', â€¦) used during reads to two pieces so values containing = remain intact
+      [$key,$val] = array_pad(explode('=', $field, 2),2,'');
       if ($time) {$val = date($notify['date'].' '.$notify['time'], $val); $time = false;}
-      $output[$i][trim($key)] = trim($val);
+      # unescape the value before emitting JSON, so the browser UI
+      # and any scripts calling `notify get` still see plain strings
+      $output[$i][trim($key)] = ini_decode_value($val);
     }
     $i++;
   }
   echo json_encode($output, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE);
   break;
