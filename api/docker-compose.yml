x-volumes: &volumes
  volumes:
  - ./:/app

services:

  dev:
    image: unraid-api:development
    ports:
      - "3001:3001"
    build: 
      context: .
      target: development
      dockerfile: Dockerfile
    <<: *volumes
    stdin_open: true
    tty: true
    entrypoint: /bin/bash
    environment: 
      - IS_DOCKER=true
      - GIT_SHA=${GIT_SHA:?err}
      - IS_TAGGED=${IS_TAGGED}
    profiles:
      - builder

  local:
    image: unraid-api:development
    ports:
      - "3001:3001"
    build: 
      context: .
      target: development
      dockerfile: Dockerfile
    <<: *volumes
    command: npm run start:dev
    environment: 
      - IS_DOCKER=true
      - GIT_SHA=${GIT_SHA:?err}
      - IS_TAGGED=${IS_TAGGED}
    profiles:
      - builder

  builder:
    image: unraid-api:builder
    environment:
      - GIT_SHA=${GIT_SHA:?err}
      - IS_TAGGED=${IS_TAGGED}
    build: 
      context: .
      target: builder
      dockerfile: Dockerfile
    <<: *volumes
    profiles:
      - builder