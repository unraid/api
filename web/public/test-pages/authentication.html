<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Flow - Unraid Component Test</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .auth-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .auth-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .auth-card h2 {
      margin: 0 0 20px 0;
      color: #1f2937;
    }
    .user-info {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 10px;
    }
    .status-badge.authenticated {
      background: #10b981;
      color: white;
    }
    .status-badge.unauthenticated {
      background: #ef4444;
      color: white;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <!-- Login Card -->
    <div class="auth-card">
      <h2>üîê Authentication</h2>
      <unraid-auth></unraid-auth>
      <div class="user-info">
        <strong>Session Status:</strong>
        <div id="auth-status">
          <span class="status-badge unauthenticated">Not Authenticated</span>
        </div>
      </div>
    </div>

    <!-- SSO Options -->
    <div class="auth-card">
      <h2>üîó Single Sign-On</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">Alternative authentication methods</p>
      <unraid-sso-button></unraid-sso-button>
    </div>

    <!-- User Profile -->
    <div class="auth-card">
      <h2>üë§ User Profile</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">Displays when authenticated</p>
      <unraid-user-profile id="user-profile"></unraid-user-profile>
    </div>

    <!-- Registration -->
    <div class="auth-card">
      <h2>üìù System Registration</h2>
      <unraid-registration></unraid-registration>
    </div>

    <!-- Test Controls -->
    <div class="auth-card" style="background: #1f2937; color: white;">
      <h2 style="color: white;">üß™ Test Controls</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="simulate-login" class="btn">Simulate Login</button>
        <button id="simulate-logout" class="btn">Simulate Logout</button>
        <button id="update-profile" class="btn">Update Profile</button>
        <button id="check-session" class="btn">Check Session</button>
      </div>
      <div id="console-output" style="margin-top: 20px; padding: 10px; background: black; border-radius: 4px; font-family: monospace; font-size: 12px; min-height: 80px;">
        > Ready...
      </div>
    </div>
  </div>

  <style>
    .btn {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #2563eb;
    }
  </style>

  <!-- Global Modals -->
  <unraid-modals></unraid-modals>

  <!-- Load the manifest -->
  <script src="/test-pages/load-manifest.js"></script>

  <!-- Authentication test logic -->
  <script>
    $(document).ready(function() {
      const output = $('#console-output');
      let isAuthenticated = false;
      
      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        output.append('\n> [' + timestamp + '] ' + message);
        output.scrollTop(output[0].scrollHeight);
      }
      
      // Simulate login
      $('#simulate-login').on('click', function() {
        log('Simulating login...');
        isAuthenticated = true;
        
        const userData = {
          username: 'admin',
          email: 'admin@unraid.local',
          name: 'Administrator',
          avatarUrl: '/webGui/images/default-avatar.png',
          role: 'admin',
          sessionId: 'sess_' + Math.random().toString(36).substr(2, 9)
        };
        
        // Update components
        $('#user-profile').attr('server', JSON.stringify(userData));
        $('#auth-status').html('<span class="status-badge authenticated">Authenticated as ' + userData.username + '</span>');
        
        // Dispatch login event
        $(document).trigger('unraid:auth-login', userData);
        log('Login successful: ' + userData.username);
      });
      
      // Simulate logout
      $('#simulate-logout').on('click', function() {
        log('Simulating logout...');
        isAuthenticated = false;
        
        $('#user-profile').attr('server', '{}');
        $('#auth-status').html('<span class="status-badge unauthenticated">Not Authenticated</span>');
        
        // Dispatch logout event
        $(document).trigger('unraid:auth-logout');
        log('Logged out successfully');
      });
      
      // Update profile
      $('#update-profile').on('click', function() {
        if (!isAuthenticated) {
          log('Error: Not authenticated');
          return;
        }
        
        log('Updating profile...');
        const updatedData = {
          username: 'admin',
          email: 'newemail@unraid.local',
          name: 'Updated Admin',
          lastModified: new Date().toISOString()
        };
        
        $('#user-profile').attr('server', JSON.stringify(updatedData));
        log('Profile updated');
      });
      
      // Check session
      $('#check-session').on('click', function() {
        log('Checking session status...');
        log('Authenticated: ' + (isAuthenticated ? 'Yes' : 'No'));
        
        if (isAuthenticated) {
          // Would normally make an API call here
          log('Session valid until: ' + new Date(Date.now() + 3600000).toLocaleTimeString());
        }
      });
      
      // Listen for auth events from components
      $(document).on('unraid:auth-required', function() {
        log('Authentication required by component');
      });
      
      $(document).on('unraid:session-expired', function() {
        log('Session expired - please login again');
        $('#simulate-logout').click();
      });
      
      log('Authentication test page ready');
    });
  </script>
</body>
</html>