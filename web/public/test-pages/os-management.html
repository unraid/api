<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OS Management - Unraid Component Test</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .header {
      background: #1f2937;
      color: white;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .info-bar {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .version-info {
      display: flex;
      gap: 30px;
    }
    .version-item {
      display: flex;
      flex-direction: column;
    }
    .version-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .version-value {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-top: 4px;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card h2 {
      margin: 0 0 20px 0;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-description {
      color: #6b7280;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-indicator.up-to-date {
      background: #d1fae5;
      color: #065f46;
    }
    .status-indicator.update-available {
      background: #fed7aa;
      color: #92400e;
    }
    .status-indicator.checking {
      background: #dbeafe;
      color: #1e40af;
    }
    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header with OS Version -->
  <div class="header">
    <div class="container">
      <h1>
        üíø OS Management
        <unraid-header-os-version></unraid-header-os-version>
      </h1>
    </div>
  </div>

  <div class="container">
    <!-- System Information Bar -->
    <div class="info-bar">
      <div class="version-info">
        <div class="version-item">
          <span class="version-label">Current Version</span>
          <span class="version-value" id="current-version">6.12.4</span>
        </div>
        <div class="version-item">
          <span class="version-label">Latest Available</span>
          <span class="version-value" id="latest-version">6.12.5</span>
        </div>
        <div class="version-item">
          <span class="version-label">Update Channel</span>
          <span class="version-value" id="update-channel">Stable</span>
        </div>
      </div>
      <div class="status-indicator update-available" id="update-status">
        <span>‚óè</span> Update Available
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Update OS Card -->
      <div class="card">
        <h2>‚¨ÜÔ∏è System Updates</h2>
        <p class="card-description">Check for and install Unraid OS updates</p>
        <unraid-update-os></unraid-update-os>
      </div>

      <!-- Downgrade OS Card -->
      <div class="card">
        <h2>‚¨áÔ∏è System Downgrade</h2>
        <p class="card-description">Rollback to a previous Unraid OS version</p>
        <unraid-downgrade-os></unraid-downgrade-os>
      </div>
    </div>

    <!-- Test Controls -->
    <div class="card" style="margin-top: 20px; background: #1f2937;">
      <h2 style="color: white;">üß™ Test Scenarios</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <button class="test-btn" id="check-updates">Check for Updates</button>
        <button class="test-btn" id="simulate-update">Simulate Update Available</button>
        <button class="test-btn" id="simulate-current">Simulate Up-to-date</button>
        <button class="test-btn" id="change-channel">Switch Channel (Beta)</button>
        <button class="test-btn" id="simulate-download">Simulate Download Progress</button>
        <button class="test-btn" id="simulate-install">Simulate Installation</button>
      </div>
      
      <div style="margin-top: 20px;">
        <div style="background: black; color: #10b981; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; min-height: 120px; max-height: 200px; overflow-y: auto;" id="console">
          > OS Management Test Console
          > Ready for testing...
        </div>
      </div>
    </div>
  </div>

  <style>
    .test-btn {
      padding: 10px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .test-btn:hover {
      background: #2563eb;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 15px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 500;
    }
  </style>

  <!-- Global Modals -->
  <unraid-modals></unraid-modals>

  <!-- Load manifest -->
  <script src="/test-pages/load-manifest.js"></script>

  <!-- Test Logic -->
  <script>
    $(document).ready(function() {
      const $console = $('#console');
      let currentVersion = '6.12.4';
      let latestVersion = '6.12.5';
      let updateChannel = 'stable';
      
      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '>';
        $console.append('\n' + prefix + ' [' + timestamp + '] ' + message);
        $console.scrollTop($console[0].scrollHeight);
      }
      
      // Check for updates
      $('#check-updates').on('click', function() {
        log('Checking for updates...');
        $('#update-status').removeClass('up-to-date update-available').addClass('checking');
        $('#update-status').html('<span>‚ü≥</span> Checking...');
        
        setTimeout(function() {
          if (currentVersion !== latestVersion) {
            $('#update-status').removeClass('checking up-to-date').addClass('update-available');
            $('#update-status').html('<span>‚óè</span> Update Available');
            log('Update available: ' + latestVersion, 'success');
          } else {
            $('#update-status').removeClass('checking update-available').addClass('up-to-date');
            $('#update-status').html('<span>‚úì</span> Up to Date');
            log('System is up to date', 'success');
          }
        }, 2000);
      });
      
      // Simulate update available
      $('#simulate-update').on('click', function() {
        latestVersion = '6.12.6';
        $('#latest-version').text(latestVersion);
        $('#update-status').removeClass('up-to-date checking').addClass('update-available');
        $('#update-status').html('<span>‚óè</span> Update Available');
        log('Simulated update available: ' + latestVersion);
        
        // Trigger component update
        $('unraid-update-os').attr('latest-version', latestVersion);
      });
      
      // Simulate up-to-date
      $('#simulate-current').on('click', function() {
        currentVersion = latestVersion = '6.12.5';
        $('#current-version').text(currentVersion);
        $('#latest-version').text(latestVersion);
        $('#update-status').removeClass('update-available checking').addClass('up-to-date');
        $('#update-status').html('<span>‚úì</span> Up to Date');
        log('System is now up to date');
      });
      
      // Change channel
      $('#change-channel').on('click', function() {
        updateChannel = updateChannel === 'stable' ? 'beta' : 'stable';
        $('#update-channel').text(updateChannel.charAt(0).toUpperCase() + updateChannel.slice(1));
        log('Switched to ' + updateChannel + ' channel');
        
        if (updateChannel === 'beta') {
          latestVersion = '6.13.0-beta1';
          $('#latest-version').text(latestVersion);
          log('Beta version available: ' + latestVersion);
        } else {
          latestVersion = '6.12.5';
          $('#latest-version').text(latestVersion);
        }
      });
      
      // Simulate download progress
      $('#simulate-download').on('click', function() {
        log('Starting download simulation...');
        
        const $card = $(this).closest('.card');
        if (!$card.find('.progress-bar').length) {
          $card.append('<div class="progress-bar"><div class="progress-fill" style="width: 0%">0%</div></div>');
        }
        
        let progress = 0;
        const interval = setInterval(function() {
          progress += 10;
          $('.progress-fill').css('width', progress + '%').text(progress + '%');
          log('Download progress: ' + progress + '%');
          
          if (progress >= 100) {
            clearInterval(interval);
            log('Download complete!', 'success');
            setTimeout(function() {
              $('.progress-bar').fadeOut();
            }, 2000);
          }
        }, 500);
      });
      
      // Simulate installation
      $('#simulate-install').on('click', function() {
        log('Preparing installation...');
        log('Creating backup...');
        
        setTimeout(function() {
          log('Backup complete', 'success');
          log('Installing update...');
          
          setTimeout(function() {
            log('Installation complete!', 'success');
            log('System will restart in 30 seconds...');
            currentVersion = latestVersion;
            $('#current-version').text(currentVersion);
          }, 3000);
        }, 2000);
      });
      
      // Listen for component events
      $(document).on('unraid:update-started', function(e, data) {
        log('Update started: ' + data.version);
      });
      
      $(document).on('unraid:update-complete', function(e, data) {
        log('Update complete: ' + data.version, 'success');
      });
      
      log('OS Management test page initialized');
    });
  </script>
</body>
</html>