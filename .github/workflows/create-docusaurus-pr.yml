name: Update API Documentation
on:
  push:
    branches:
      - main
    paths:
      - 'api/docs/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Add permissions for GITHUB_TOKEN
permissions:
  contents: write
  pull-requests: write
jobs:
  create-docs-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Checkout docs repository
        uses: actions/checkout@v4
        with:
          repository: unraid/docs
          path: docs-repo
          token: ${{ secrets.DOCS_PAT_UNRAID_BOT }}

      - name: Copy updated docs
        run: |
          if [ ! -d "source-repo/api/docs" ]; then
            echo "Source directory does not exist!"
            exit 1
          fi
          rm -rf docs-repo/docs/api/
          mkdir -p docs-repo/docs/api
          cp -r source-repo/api/docs/public* docs-repo/docs/api/
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_PAT_UNRAID_BOT }}
          path: docs-repo
          commit-message: 'docs: update API documentation'
          title: 'Update API Documentation'
          body: |
            This PR updates the API documentation based on changes from the main repository.
            
            Changes were automatically generated from api/docs/* directory.
          branch: update-api-docs
          base: main
          delete-branch: true
