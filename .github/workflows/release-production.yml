name: Publish Release to Digital Ocean

on:
  release:
    types: [published]

jobs:
  publish-to-digital-ocean:
    runs-on: ubuntu-latest

    steps:
      - name: Download Release Artifacts (Plugins)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          file: ".*"
          regex: true
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "./"
          version: "latest"

      - uses: cardinalby/git-get-release-action@v1
        id: release-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          latest: true
          prerelease: false
      - name: Get Release Changelog
        run: |
          notes=$(cat << EOF
          ${{ steps.release-info.outputs.body }}
          EOF
          )
          escapedNotes=$(sed -e 's/[&\\/]/\\&/g; s/$/\\/' -e '$s/\\$//' <<<"$notes")
          sed -i -z -E "s/<CHANGES>(.*)<\/CHANGES>/<CHANGES>\n${escapedNotes}\n<\/CHANGES>/g" "dynamix.unraid.net.plg"

      - name: Upload All Release Files to DO Spaces
        uses: BetaHuhn/do-spaces-action@v2
        with:
          access_key: ${{ secrets.DO_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SECRET_KEY }}
          space_name: ${{ secrets.DO_SPACE_NAME }}
          space_region: ${{ secrets.DO_SPACE_REGION }}
          source: "."
          out_dir: unraid-api

      - name: Upload Staging Plugin to Cloudflare Bucket
        uses: jakejarvis/s3-sync-action@v0.5.1
        env:
          AWS_S3_ENDPOINT: ${{ secrets.CF_ENDPOINT }}
          AWS_S3_BUCKET: ${{ secrets.CF_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.CF_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CF_SECRET_ACCESS_KEY }}
          AWS_REGION: 'auto'
          SOURCE_DIR: "."
          DEST_DIR: unraid-api
