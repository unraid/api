Menu="ManagementAccess:200"
Title="Callback Tests"
Icon="icon-u-globe"
Tag="globe"
---
<?php
$myservers_flash_cfg_path='/boot/config/plugins/dynamix.my.servers/myservers.cfg';
$myservers = file_exists($myservers_flash_cfg_path) ? @parse_ini_file($myservers_flash_cfg_path,true) : [];
// print_r($mystatus);
// extract web component JS file from manifest
$jsonManifest = file_get_contents('/usr/local/emhttp/plugins/dynamix.my.servers/webComponents/manifest.json');
$jsonManifestData = json_decode($jsonManifest, true);
$webComponentFile = $jsonManifestData["connect-components.client.mjs"]["file"];
// web component
$localSource = '/plugins/dynamix.my.servers/webComponents/' . $webComponentFile;
// add the web component source to the DOM
echo '<script id="unraid-webcomponents" defer src="' . $localSource . '"></script>';

$serverData = [
  "avatar" => (!empty($myservers['remote']['avatar']) && $plgInstalled) ? $myservers['remote']['avatar'] : '',
  "config" => [
    'valid' => $var['configValid'] === 'yes',
    'error' => $var['configValid'] !== 'yes'
      ? (array_key_exists($var['configValid'], $configErrorEnum) ? $configErrorEnum[$var['configValid']] : 'UNKNOWN_ERROR')
      : null,
  ],
  "deviceCount" => $var['deviceCount'],
  "email" => $myservers['remote']['email'] ?? '',
  "extraOrigins" => explode(',', $myservers['api']['extraOrigins']??''),
  "flashproduct" => $var['flashProduct'],
  "flashvendor" => $var['flashVendor'],
  "flashBackupActivated" => empty($flashbackup_status['activated']) ? '' : 'true',
  "guid" => $var['flashGUID'],
  "hasRemoteApikey" => !empty($myservers['remote']['apikey']),
  "internalip" => ipaddr(),
  "internalport" => $_SERVER['SERVER_PORT'],
  "keyfile" => empty($var['regFILE'])? "" : str_replace(['+','/','='], ['-','_',''], trim(base64_encode(@file_get_contents($var['regFILE'])))),
  "locale" => 'en',
  "osVersion" => $var['version'],
  "plgVersion" => $plgversion = file_exists('/var/log/plugins/dynamix.unraid.net.plg')
    ? trim(@exec('/usr/local/sbin/plugin version /var/log/plugins/dynamix.unraid.net.plg 2>/dev/null'))
    : ( file_exists('/var/log/plugins/dynamix.unraid.net.staging.plg')
        ? trim(@exec('/usr/local/sbin/plugin version /var/log/plugins/dynamix.unraid.net.staging.plg 2>/dev/null'))
        : 'base-'.$var['version'] ),
  "plgInstalled" => $plgInstalled,
  "protocol" => $_SERVER['REQUEST_SCHEME'],
  "reggen" => (int)$var['regGen'],
  "regGuid" => $var['regGUID'],
  "registered" => (!empty($myservers['remote']['username']) && $plgInstalled),
  "name" => $var['NAME'],
  "site" => $_SERVER['REQUEST_SCHEME']."://".$_SERVER['HTTP_HOST'],
  "state" => strtoupper(empty($var['regCheck']) ? $var['regTy'] : $var['regCheck']),
  "ts" => time(),
  "username" => (!empty($myservers['remote']['username']) && $plgInstalled) ? $myservers['remote']['username'] : '',
  "wanFQDN" => $nginx['NGINX_WANFQDN'] ?? '',
];

echo "<connect-user-profile server='" . json_encode($serverData) . "'></connect-user-profile>";
?>
<connect-callback-handler></connect-callback-handler>
<connect-auth></connect-auth>
<connect-key-actions></connect-key-actions>
<connect-launchpad></connect-launchpad>
<connect-plugin-promo></connect-plugin-promo>
<connect-wan-ip-check></connect-wan-ip-check>
